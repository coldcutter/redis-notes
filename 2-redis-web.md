# 2 Redis Web应用剖析

本章，我们要解决网上零售商店的一些问题，假设这个网店每天接收来自500万独立用户的1亿次点击，购买超过10万件商品。如果能解决这个大规模的问题，规模更小的会更容易，尽管数据量巨大，但是大部分都能使用1台Redis服务器处理，内存不超过几G。

## 2.1 登录与cookie缓存

有两种常用的方法用于在cookies中存储登录信息：a signed cookie or a token cookie。 _Signed cookies_ 主要存储用户名，也可能是用户ID，还有其他有用的信息，当然包括一个签名，服务器通过签名来确认浏览器发送的信息没有被修改。 _Token cookies_ 使用随机串，服务器通过这个串从数据库中查询对应的用户。随着时间的推移，旧的tokens可以被删除，下面是两种方式的利弊：

![](/assets/QQ20160804-1@2x.png)

我们使用token cookie，在关系数据库表中存用户登录信息，还可以存用户浏览了多长时间，浏览过多少商品等。但是随着用户的浏览会导致大量的数据库写操作，大部分关系数据库会遇到单台服务器每秒插入、更新和删除200~2000行的瓶颈。尽管可以使用批量操作提升性能，但是每次浏览只会有少数几行更新，所以不管用。

现在，由于相对高的负载（平均每秒1200次写，峰值6000次写），我们得用10台数据库服务器来支撑，我们用Redis来替换。

我们使用一个HASH来存储token到登录用户的映射，下面是获取登录用户的函数：

```
def check_token(conn, token):
    return conn.hget('login:', token)
```



